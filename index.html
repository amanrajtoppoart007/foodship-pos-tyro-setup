<!DOCTYPE html>
<!--suppress ES6ConvertVarToLetConst -->
<html lang="en">
<head>
<title>Tyro iClient Samples</title>
<link rel="stylesheet" href="//code.jquery.com/ui/1.10.1/themes/base/jquery-ui.css"/>
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.0/css/bootstrap-combined.min.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/prettify/r224/prettify.css">
<style>
    body {
        padding-top: 60px;
        padding-bottom: 40px;
    }
    .mt15 {
        margin-top: 15px;
    }
    .hidden {
        display: none;
    }
</style>
<script type="text/javascript" src="//code.jquery.com/jquery-1.9.1.js"></script>
<script type="text/javascript" src="//code.jquery.com/ui/1.10.1/jquery-ui.js"></script>
<script type="text/javascript" src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/js/bootstrap.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/prettify/r224/prettify.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>
<script type="text/javascript" src="https://iclientsimulator.test.tyro.com/iclient-with-ui-v1.js"></script>
<script type="text/javascript">
    // Only required because we are loading both iClient versions into the global namespace
    var TYROUI_SIMULATOR = TYRO;
</script>
<script type="text/javascript" src="https://iclientsimulator.test.tyro.com/iclient-v1.js"></script>
<script type="text/javascript">
    // Only required because we are loading both iClient versions into the global namespace
    var CUSTOMUI_SIMULATOR = TYRO;
</script>
<script type="text/javascript" src="https://iclient.test.tyro.com/iclient-with-ui-v1.js"></script>
<script type="text/javascript" src="https://iclient.test.tyro.com/iclient-v1.js"></script>
<script type="text/javascript">
var system = [TYROUI_SIMULATOR, CUSTOMUI_SIMULATOR];
var apiKey = "Test API Key";  // API Key isn't validated in either test environment
var posProductInfo = {posProductVendor: "Tyro Payments", posProductName: "Mini Cloud POS", posProductVersion: "1.0.0"};
var simulator = true;

function showTransactionPage() {
    highlightNavigationBar("transactions");
    showTransactionNavigation();
    showPurchaseWithTyroUI();
}



function showConfigurationPage() {
    highlightNavigationBar("configuration");
    showPairing();
}

function showTransactionNavigation() {
    $("#navigation").html($("#transactionsNavigation").html());
}


function showPurchaseWithTyroUI() {
    highlightNavigation("purchaseWithTyroUI");
    $("#content").html($("#purchaseWithTyroUIContent").html());
}

function showRefundWithTyroUI() {
    highlightNavigation("refundWithTyroUI");
    $("#content").html($("#refundWithTyroUIContent").html());
}



function showPairing() {
    highlightNavigation("pairing");
    $("#content").html($("#pairingContent").html());
    const iClient = new system[1].IClient(apiKey, posProductInfo);
    iClient.getConfiguration(function(config) {
        $("#mid").val(config.mid);
        $("#tid").val(config.tid);
    });
}


function highlightNavigationBar(selected) {
    const selector = $("#" + selected);
    if (!selector.hasClass("active")) {
        selector.addClass("active")
    }
    $("#navigation-bar").children("li").each(function () {
        if (this.id !== selected) {
            $(this).removeClass("active");
        }
    });
}

function highlightNavigation(selected) {
    const element = $("#" + selected);
    if (!element.hasClass("active")) {
        element.addClass("active")
    }
    $("#navigation").children("li").each(function () {
        if (this.id !== selected) {
            $(this).removeClass("active");
        }
    });
}

$().ready(function () {
    showConfigurationPage();
    setTimeout(()=>{
        $("#mid").val(329);
         $("#tid").val(100);
    },3000);
    setTimeout(()=>{
        doPairing();
    },3000);
});

function doPurchaseWithTyroUI() {
    $("#result").html('');
    $("#merchantReceipt").html('');
    $("#customerReceipt").html('');
    const amount = $("#amount").val();
    const cashout = $("#cashout").val();
    const iClient = new system[0].IClientWithUI(apiKey, posProductInfo);
    iClient.initiatePurchase({amount: amount, cashout: cashout, integratedReceipt: true}, {
        receiptCallback: function (receipt) {
            console.log("Print merchant receipt:");
            console.log(JSON.stringify(receipt));
            $("#merchantReceipt").html(formatReceipt(receipt.merchantReceipt));
        },
        transactionCompleteCallback: function (response) {
            console.log("Purchase response: " + JSON.stringify(response));
            if (response.customerReceipt) {
                $("#customerReceipt").html(formatReceipt(response.customerReceipt));
            }
            $("#result").html(formatResult(response));
        }
    });
}

function doRefundWithTyroUI() {
    $("#refund_result").html('');
    $("#refund_merchantReceipt").html('');
    $("#refund_customerReceipt").html('');
    const amount = $("#refund_amount").val();
    const iClient = new system[0].IClientWithUI(apiKey, posProductInfo);
    iClient.initiateRefund({amount: amount, integratedReceipt: true}, {
        receiptCallback: function (receipt) {
            console.log("Print merchant receipt:");
            console.log(JSON.stringify(receipt));
            $("#refund_merchantReceipt").html(formatReceipt(receipt.merchantReceipt));
        },
        transactionCompleteCallback: function (response) {
            console.log("Refund response: " + JSON.stringify(response));
            if (response.customerReceipt) {
                $("#refund_customerReceipt").html(formatReceipt(response.customerReceipt));
            }
            $("#refund_result").html(formatResult(response));
        }
    });
}

function doPairing() {
    const mid = $("#mid").val();
    const tid = $("#tid").val();
    const iClient = new system[1].IClient(apiKey, posProductInfo);
    iClient.pairTerminal(mid, tid, function(response) {
        if ("success" === response.status) {
            console.log("Pairing success: " + JSON.stringify(response));
            $("#pair_result").text("Success: " + response.message);
        } else if ("failure" === response.status) {
            console.log("Pairing failure: " + JSON.stringify(response));
            $("#pair_result").text("Failure: " + response.message);
        } else {
            $("#pair_result").text(response.message);
        }
    });
}

function formatReceipt(text) {
    return "<pre>" + text + "</pre>";
}

function formatResult(response) {
    let result = "<table>";
    result += "<tr><td>Result:</td><td>" + response.result + "</td></tr>"
    result += "</table>";
    return result;
}
</script>
</head>
<body>
<div class="container-fluid">
    <div class="row-fluid" style="height: 600px;">
        <div class="span2">
            <div class="well sidebar-nav">
                <ul id="navigation" class="nav nav-list">
                </ul>
            </div>
        </div>
        <div class="span10">
            <div id="content"></div>
        </div>
    </div>
    <hr>
    <footer>
        <p>&copy; Tyro Payments 2015</p>
    </footer>
</div>
<ul id="transactionsNavigation" class="hidden">
    <li id="configuration"><a href="javascript:showConfigurationPage()">Configuration</a></li>
    <li id="purchaseWithTyroUI"><a href="javascript:showPurchaseWithTyroUI()">Purchase</a></li>
    <li id="refundWithTyroUI"><a href="javascript:showRefundWithTyroUI()">Refund</a></li>
</ul>
<div id="purchaseWithTyroUIContent" class="hidden">
    <div class="container-fluid">
        <div class="span3">
            <h2>Purchase</h2>
            <div class="mt15">
                <label for="amount">Amount:</label>
                <input id="amount" type="text" placeholder="Amount" name="amount" value="10000">
            </div>
            <div class="mt15">
                <label for="cashout">Cash out:</label>
                <input id="cashout" type="text" placeholder="Cash out" name="cashout" value="0">
            </div>
            <div class="mt15">
                <button type="button" class="btn btn-primary" onclick="doPurchaseWithTyroUI()">Process</button>
            </div>
        </div>
        <div class="span3">
            <h2>Result</h2>
            <div id="result"></div>
        </div>
        <div class="span3">
            <h2>Receipts</h2>
            <div id="merchantReceipt" style="width: 250px;"></div>
        </div>
        <div class="span3">
            <h2>&nbsp;</h2>
            <div id="customerReceipt" style="width: 250px;"></div>
        </div>
    </div>
</div>
<div id="refundWithTyroUIContent" class="hidden">
    <div class="container-fluid">
        <div class="span3">
            <h2>Refund</h2>
            <div class="mt15">
                <label for="refund_amount">Amount:</label>
                <input id="refund_amount" type="text" placeholder="Amount" name="amount" value="10208">
            </div>
            <div class="mt15">
                <button type="button" class="btn btn-primary" onclick="doRefundWithTyroUI()">Process</button>
            </div>
        </div>
        <div class="span3">
            <h2>Result</h2>
            <div id="refund_result"></div>
        </div>
        <div class="span3">
            <h2>Receipts</h2>
            <div id="refund_merchantReceipt" style="width: 250px;"></div>
        </div>
        <div class="span3">
            <h2>&nbsp;</h2>
            <div id="refund_customerReceipt" style="width: 250px;"></div>
        </div>
    </div>
</div>
<div id="pairingContent" class="hidden">
    <div class="container-fluid">
        <div class="span3">
            <h2>Configuration</h2>
            <div class="mt15">
                <label for="mid">Merchant ID:</label>
                <input id="mid" type="text" placeholder="Merchant ID" name="mid">
            </div>
            <div class="mt15">
                <label for="tid">Terminal ID:</label>
                <input id="tid" type="text" placeholder="Terminal ID" name="tid">
            </div>
            <div class="mt15">
                <button type="button" class="btn btn-primary" onclick="doPairing()">Commence Pairing</button>
            </div>
        </div>
        <div class="span9">
            <div style="height: 200px;">
                <h2>Messages</h2>
                <div id="messages"></div>
            </div>
            <div style="height: 200px;">
                <h2>Result</h2>
                <div id="pair_result"></div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
